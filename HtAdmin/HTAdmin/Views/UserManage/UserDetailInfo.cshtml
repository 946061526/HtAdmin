
@{
    ViewBag.Title = "UserDetailInfo";
    var user = ViewBag.UserDetailInfo as External.Core.Users.UserDetailInfo;

}
@section styles{
    <style>
        .select {
            width: 100%;
            padding: 8px 5px;
            display: block;
            border: solid 1px #eaeaea;
        }

        .pd {
            padding: 20px 10px 20px 0;
        }

        .layui-form-label {
            width: 90px;
        }
        .li-wd-200{
            float:left;
            width:200px;
        }
    </style>
}
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header" style="font-weight:bolder">基本信息</div>
                <div class="layui-card-body">
                    <div class="layui-row">
                        <div class="li-wd-200">
                            用户Id：@user.UserId
                        </div>
                        <div class="li-wd-200">
                            手机号码：@user.Mobile
                        </div>
                        <div class="li-wd-200">
                            昵称：@user.DisplayName
                        </div>
                    </div>
                    <div class="layui-row">
                        <div class="li-wd-200">
                            注册来源：@user.ComeFrom
                        </div>
                        <div class="li-wd-200">
                            注册时间：@user.RegTime.ToString("yyyy-MM-dd HH:mm")
                        </div>
                        <div class="li-wd-200">
                            账号状态：@if (user.IsEnable)
                            {
                                <span>@("已启用 ") </span>
                                <a class='layui-btn layui-btn-xs layui-btn-normal' IsEnable val="0"> 禁用 </a>

                            }
                            else
                            {
                                <span>@("已禁用 ") </span>
                                <a class='layui-btn layui-btn-xs layui-btn-normal' IsEnable val="1">启用</a>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">
                    <span style="font-weight:bolder">安全信息</span>
                    <button  class='layui-btn layui-btn-xs layui-btn-normal' id="modifyRealName">修改实名认证</button>
                    <button  class='layui-btn layui-btn-xs layui-btn-normal' id="modifyBankCard">修改银行卡</button>
                </div>
                <div class="layui-card-body">
                    <div class="layui-row">
                        <div class="li-wd-200">
                            登录密码：******** <a class='layui-btn layui-btn-xs layui-btn-normal' id="resetLoginPassword">重置</a>
                        </div>
                        <div class="li-wd-200">
                            支付密码：****** <a class='layui-btn layui-btn-xs layui-btn-normal' id="resetPayPassword">重置</a>
                        </div>
                        <div class="li-wd-200">
                            手机号码：@user.Mobile <a class='layui-btn layui-btn-xs layui-btn-normal' id="resetMobile">修改</a>
                        </div>
                    </div>
                    <div class="layui-row">
                        <div class="li-wd-200">
                            实名认证：@user.RealName
                        </div>
                        <div class="li-wd-200">
                            身份证号码：@user.IdCardNumber
                        </div>
                        <div class="li-wd-200">

                        </div>
                    </div>
                    <div class="layui-row">
                        <div class="li-wd-200">
                            银行卡认证：@user.BankName
                        </div>
                        <div class="li-wd-200">
                            支行：@user.BankSubName
                        </div>
                        <div class="li-wd-200">
                            银行卡号：@user.BankCardNumber
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span style="font-weight:bolder">资金信息</span>
                    <a class='layui-btn layui-btn-xs layui-btn-normal' id="fillMoney">充值</a>
                    <a class='layui-btn layui-btn-xs layui-btn-normal' id="charge">扣款</a>
                </div>
                <div class="layui-card-body">
                    <div class="layui-row">
                        <div class="li-wd-200">
                            总资产：@((user.FillMoneyBalance + user.BonusBalance + user.CommissionBalance + user.RedBagBalance).ToString("c"))
                        </div>
                        <div class="li-wd-200">
                            充值账户：@user.FillMoneyBalance.ToString("c")
                        </div>
                        <div class="li-wd-200">
                            中奖账户：@user.BonusBalance.ToString("c")
                        </div>
                    </div>
                    <div class="layui-row">
                        <div class="li-wd-200">
                            冻结账户：@user.FreezeBalance.ToString("c")
                        </div>
                        <div class="li-wd-200">
                            奖励金账户：@user.RedBagBalance.ToString("c")
                        </div>
                        <div class="li-wd-200">
                            返点账户：@user.CommissionBalance.ToString("c")
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header"  style="font-weight:bolder">合买战绩</div>
                <div class="layui-card-body">
                    <div class="layui-row">
                        <div class="li-wd-200">
                            发单次数：@user.ChippedCount
                        </div>
                        <div class="li-wd-200">
                            成功次数：@user.ChippedSuccessCount
                        </div>
                    </div>
                    <div class="layui-row">
                        <div class="li-wd-200">
                            中奖次数：@user.ChippedBonusCount
                        </div>
                        <div class="li-wd-200">
                            中奖金额：@user.ChippedBonusMoney.ToString("c")
                        </div>
                        <div class="li-wd-200">

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header" style="font-weight:bolder">登录记录</div>
                <div class="layui-card-body">
                    <table class="layui-table w-text-nowrap" lay-skin="line" id="tableLogin"></table>
                </div>
            </div>
        </div>
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header" style="font-weight:bolder">红包</div>
                <div class="layui-card-body">
                    <table class="layui-table w-text-nowrap" lay-skin="line" id="tableRedBag" style="width:100%"></table>
                </div>
            </div>
        </div>
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header" style="font-weight:bolder">购彩记录</div>
                <div class="layui-card-body">
                    <table class="layui-table w-text-nowrap" lay-skin="line" id="tableLotteryRecord"></table>
                </div>
            </div>
        </div>
    </div>
</div>



@section scripts{
    <script type="text/javascript">
        $(function () {
            var userId = '@ViewBag.UserId';
            var layer = layui.layer;
            var table = layui.table;
            var form = layui.form;
            $("a[IsEnable]").click(function () {
                var $th = $(this);
                var val = $th.attr("val");
                var msg = '确定要启用用户吗？';
                if (val == '0') {
                    msg = '确定要禁用用户吗？';
                }
                layer.confirm(msg, function (index) {
                    $.post("/UserManage/EnableUser", { userId:userId,isEnabled: val }, function (r) {
                        if (r.status == 1) {
                            if (val == '0') {
                                $th.siblings("已禁用");
                                $th.text("启用");
                                $th.removeClass("layui-btn-danger").addClass("layui-btn-normal");
                            }
                            else {
                                $th.siblings("已启用");
                                $th.text("禁用");
                                $th.removeClass("layui-btn-normal").addClass("layui-btn-danger");
                            }
                            window.location.reload();
                        }
                        layer.close(index);
                    });
                });
            });

            $("#modifyRealName").click(function () {
                layer.open({
                    type: 1,
                    title: "修改实名认证",
                    area:["440px","250px"],
                    content: '<div class="pd" id="divRealName">'
                        + '<div class= "layui-form-item" >'
                        + '       <label class="layui-form-label">姓名：</label>'
                        + '       <div class="layui-input-block">'
                        + '        <input type="text" name="RealName" style="width:94%" placeholder="请输入姓名" autocomplete="off" class="layui-input">'
                        + '      </div>'
                        + ' </div>'
                        + '      <div class="layui-form-item">'
                        + '           <label class="layui-form-label">身份证号：</label>'
                        + '          <div class="layui-input-block">'
                        + '               <input type="text" name="CardNumber" style="width:94%"  placeholder="请输入身份证号" autocomplete="off" class="layui-input">'
                        + '          </div>'
                        + '     </div>'
                        + '</div>',
                    btn: ['确定', '取消'],
                    yes: function (index) {
                        var $card = $("#divRealName input[name='CardNumber']");
                        var $name = $("#divRealName input[name='RealName']");
                        if (!$name.val() || $name.val().length < 1) {
                            layer.tips('请输入姓名，且长度不可以小于1个字', $name, {
                                tips: 1,
                                time: 2000
                            });
                            return false;
                        }
                        var regIdCard = /^(^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$)|(^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])((\d{4})|\d{3}[Xx])$)$/;
                        if (!$card.val() || regIdCard.test($card.val())==false) {
                            layer.tips('请输入正确的身份证号', $card, {
                                tips: 1,
                                time: 2000
                            });
                            return false;
                        }

                        $.post("/UserManage/ReauthenticateUser", { userId: userId, realName: $name.val(), cardNumber:$card.val() }, function (r) {
                            if (r.status == 1) {
                                window.location.reload();
                            }
                            else {
                                layer.alert(r.message);
                            }
                        })
                    }
                });
            });
            $("#modifyBankCard").click(function () {
                layer.open({
                    type: 2,// 表示是iframe弹框
                    title: "修改银行卡",
                    content:"/UserManage/ModifyBankInfo?userId="+userId,
                    area: ["440px", "320px"],
                    end: function () {
                        window.location.reload();
                    }
                });
            });

            $("#resetLoginPassword").click(function () {
                var th = this;
                var curindex = layer.open({
                    type: 1,
                    area: ["440px", "250px"],
                    content: '<div class="layui-form-item" style="margin:20px 10px 20px 0;">'
                        + '<label class= "layui-form-label">登录密码</label>'
                        + '<input type="password" id="loginpassword" style="width:70%;" name="loginpassword"  required lay-verify="required" placeholder="请输入登录密码" autocomplete="off" class="layui-input">'
                        + '</div>',
                    btn: ['提交','取消'],
                    yes: function (index) {
                        var $pwd = $("input[name='loginpassword']");
                        if ($pwd.val().length<6) {
                            layer.tips('登录密码长度不可以小于6个字符', "#loginpassword", {
                                tips: 1,
                                time: 2000 });
                            return false;
                        }
                        $.post("/UserManage/ResetLoginPassword", { userId: userId, loginPassword: $pwd.val() }, function (r) {
                            if (r.status == 1) {
                                layer.alert(r.message, function (i) {
                                    layer.close(curindex);//关闭当前页
                                    layer.close(i);
                                });
                            }
                            else {
                                layer.alert(r.message);
                            }
                        })
                    }
                });
            });
            $("#resetPayPassword").click(function () {
                var th = this;
                var curindex = layer.open({
                    type: 1,
                    area: ["440px", "250px"],
                    content: '<div class="layui-form-item"  style="margin:20px 10px 20px 0;">'
                                +'<label class= "layui-form-label" >支付密码</label>'
                                + '<input type="password" id="paypassword"  style="width:70%;"  name="paypassword" required lay-verify="required" placeholder="请输入支付密码" autocomplete="off" class="layui-input">'
                        + '</div>',
                    btn: ['提交', '取消'],
                    yes: function (index) {
                        var $pwd = $("input[name='paypassword']");
                        if ($pwd.val().length < 6) {
                            layer.tips('支付密码长度不可以小于6个字符', "#paypassword", {
                                tips: 1,
                                time: 2000 });
                            return false;
                        }
                        $.post("/UserManage/ResetPayPassword", { userId: userId, payPassword: $pwd.val() }, function (r) {
                            if (r.status == 1) {
                                layer.alert(r.message, function (i) {
                                    layer.close(curindex);
                                    layer.close(i);
                                });
                            }
                            else {
                                layer.alert(r.message);
                            }
                        })
                    }
                });
            });
            $("#resetMobile").click(function () {
                var $th = $(this);
                layer.open({
                    type: 1,
                    area: ["440px", "250px"],
                    content: '<div class="layui-form-item"  style="margin:20px 10px 20px 0;">'
                        + '<label class= "layui-form-label" >手机号码</label>'
                        + '<input type="text" id="mobile" style="width:70%" name="mobile" required lay-verify="required" placeholder="请输入手机号码" autocomplete="off" class="layui-input">'
                        + '</div>',
                    btn: ['提交', '取消'],
                    yes: function (index) {
                        var $m = $("input[name='mobile']");
                        if (/^1[1-9]\d{9}$/.test($m.val()) == false) {
                            layer.tips('请输入正确的手机号码', $m, {
                                tips: 1,
                                time: 2000});
                            return false;
                        }
                        $.post("/UserManage/ResetMobile", { userId: userId, mobile: $m.val() }, function (r) {
                            if (r.status == 1) {
                                window.location.reload();
                            }
                            else {
                                layer.alert(r.message);
                            }
                        })
                    }
                });
            });
            $("#fillMoney").click(function () {
                debugger;
                var th = this;
                $("#frmFillMoney").show();
                layer.open({
                    type: 1,
                    area: ["440px", "350px"],
                    content: '<div class="pd" id="frmFillMoney">'
                        +'<div class= "layui-form-item" >'
                        + ' <label class="layui-form-label">充值到：</label>'
                        + '<div class="layui-input-block">'
                        + '<select name="AccountType" class="select" style="width:94%">'
                        + ' <option value="50">充值账户</option>'
                        + ' <option value="10">中奖账户</option>'
                        + '   <option value="30">返点账户</option>'
                        + '     <option value="70">奖励金账户</option>'
                        + '   </select>'
                        + '   </div>'
                        + '</div>'
                        + '  <div class="layui-form-item">'
                        + '       <label class="layui-form-label">充值金额：</label>'
                        + '       <div class="layui-input-block">'
                        + '        <input type="text"  style="width:94%" name="Recharge" pattern="^[0-9]+(.[0-9]{1,2})?$" placeholder="请输入充值金额" autocomplete="off" class="layui-input">'
                        + '       </div>'
                        + ' </div>'
                        + '      <div class="layui-form-item">'
                        + '           <label class="layui-form-label">充值说明：</label>'
                        + '          <div class="layui-input-block">'
                        + '               <input type="text" style="width:94%" name="RechargeDesc" placeholder="充值说明" autocomplete="off" class="layui-input">'
                        + '         </div>'
                        + '      </div>'
                        +'</div>',
                    btn: ['充值', '取消'],
                    yes: function (index) {
                        var $m = $("#frmFillMoney input[name='Recharge']");
                        if (/^[0-9]+(.[0-9]{1,2})?$/.test($m.val()) == false) {
                            layer.tips('请输入正确的充值金额', $m, {
                                tips: 1,
                                time: 2000
                            });
                            return false;
                        }
                        if (Number($m.val())<0) {
                            layer.tips('充值金额不可以小于0', $m, {
                                tips: 1,
                                time: 2000
                            });
                            return false;
                        }
                        var indexLoading = layer.load();
                        $.post("/UserManage/FillMoneyForUser",
                            {
                                userId: userId,
                                totalMoney: $m.val(),
                                accountType: $("#frmFillMoney select").val(),
                                description: $("frmFillMoney input[name='RechargeDesc']").val()
                            },
                            function (r) {
                                if (r.status == 1) {
                                    window.location.reload();
                                }
                                else {
                                    layer.alert(r.message);
                                }
                                layer.close(indexLoading);
                            });
                    }
                });
            });
            $("#charge").click(function () {
                var th = this;
                layer.open({
                    type: 1,
                    area: ["440px", "350px"],
                    content: ' <div class="pd" id="frmCharge">'
                        + '<div class= "layui-form-item" >'
                        + ' <label class="layui-form-label">从扣款账户：</label>'
                        + '  <div class="layui-input-block">'
                        + '     <select name="AccountType"  class="select" style="width:94%">'
                        + '         <option value="50">充值账户</option>'
                        + '         <option value="10">中奖账户</option>'
                        + '         <option value="30">返点账户</option>'
                        + '         <option value="70">奖励金账户</option>'
                        + '     </select>'
                        + '   </div>'
                        + ' </div>'
                        + '  <div class="layui-form-item">'
                        + '       <label class="layui-form-label">扣款金额：</label>'
                        + '       <div class="layui-input-block">'
                        + '        <input type="text" name="Recharge" style="width:94%" pattern="^[0-9]+(.[0-9]{1,2})?$" placeholder="请输入扣款金额" autocomplete="off" class="layui-input">'
                        + ' </div>'
                        + '     </div>'
                        + '      <div class="layui-form-item">'
                        + '           <label class="layui-form-label">扣款说明：</label>'
                        + '          <div class="layui-input-block">'
                        + '               <input type="text" name="RechargeDesc" style="width:94%" placeholder="扣款说明" autocomplete="off" class="layui-input">'
                        + '          </div>'
                        + '    </div>'
                        + '</div>',
                    btn: ['扣款', '取消'],
                    yes: function (index) {
                        var $m = $("#frmCharge input[name='Recharge']");
                        if (/^[0-9]+(.[0-9]{1,2})?$/.test($m.val()) == false) {
                            layer.tips('请输入正确的扣款金额', $m, {
                                tips: 1,
                                time: 2000
                            });
                            return false;
                        }
                        if (Number($m.val()) < 0) {
                            layer.tips('扣款金额不可以小于0', $m, {
                                tips: 1,
                                time: 2000
                            });
                            return false;
                        }
                        var indexLoading = layer.load();
                        $.post("/UserManage/ChargeForUser",
                            {
                                userId: userId,
                                totalMoney: $m.val(),
                                accountType: $("#frmCharge select").val(),
                                description: $("frmCharge input[name='RechargeDesc']").val()
                            },
                            function (r) {
                                if (r.status == 1) {
                                    window.location.reload();
                                }
                                else {
                                    layer.alert(r.message);
                                }
                                layer.close(indexLoading);
                            });

                    }
                });
            });
            var options = {
                elem: '#tableLogin'
                , url: '/UserManage/GetUserLoginHistory?userId=' + userId
                , skin: 'line'
                , loading: true
                , request: {
                    pageName: 'pageIndex', //页码的参数名称，默认：page
                    limitName: 'pageSize' //每页数据量的参数名，默认：limit
                }
                , cols: [[{ field: 'LoginTime', title: '登录时间', sort: false }
                    , { field: 'LoginIp', title: 'IP', sort: false }
                    , { field: 'IpDisplayName',  title: '地址', sort: false }
                    , {  field: 'LoginFrom',  title: '终端', sort: true, templet: function (row) {
                            if (!row.LoginFrom) {
                                return "未知";
                            }
                            return row.LoginFrom;
                        }
                    }
                ]]
                , page: true
                , limits: [10, 20, 50]
                , limit: 20
                , done: function (res, cur, count) {
                    if (typeof (count) == "number" && count <= 20) {
                        $(".layui-table-page").css("display", "none");
                    }
                }
            };
            var tableObj = table.render(options);
            var optionsLottery={
                elem: '#tableLotteryRecord'
                , url: '/UserManage/GetLotteryRecord?userId=' + userId
                , skin: 'line'
                , loading: true
                , request: {
                    pageName: 'pageIndex', //页码的参数名称，默认：page
                    limitName: 'pageSize' //每页数据量的参数名，默认：limit
                }
                , cols: [[{ field: 'BetTime', title: '购彩时间', sort: false }
                    , { field: 'GameName',  title: '彩种', sort: false }
                    , {
                        field: 'SchemeType',  title: '彩种方式', sort: false, templet: function (row) {
                            return GetBuyTypeName(row.SchemeType);
                        }
                    }
                    , {
                        field: 'TotalMoney',style: "text-align:right", title: '订单金额', sort: false, templet: function (row) {
                            return row.TotalMoney;
                        }}
                    , {
                        field: 'RedBagMoney',  style: "text-align:right", title: '奖励金抵扣', sort: false, templet: function (row) {
                            return row.RedBagMoney;
                        } }
                    , {
                        field: 'RedBagCouponMoney', style: "text-align:right", title: '红包抵扣', sort: false, templet: function (row) {
                            return row.RedBagCouponMoney;
                        } }
                ]]
                , page: true
                , limits: [10, 20, 50]
                , limit: 20
                , done: function (res, cur, count) {
                    if (typeof (count) == "number" && count <= 20) {
                        $(".layui-table-page").css("display", "none");
                    }
                }
            };
            var tableLottery = table.render(optionsLottery);

            var optionsRedBag = {
                elem: '#tableRedBag'
                , url: '/UserManage/GetRedBagRecord?userId=' + userId
                 , skin: 'line'
                , loading: true
                , request: {
                    pageName: 'pageIndex', //页码的参数名称，默认：page
                    limitName: 'pageSize' //每页数据量的参数名，默认：limit
                }
                , cols: [[{ field: 'RedBagCouponId',  title: '红包编号', sort: false }
                    , { field: 'RedBagCouponName',  title: '红包模板', sort: false }
                    , { field: 'CouponMoney', style: "text-align:right", title: '面额', sort: false }
                    , {
                        field: 'CouponUseGames',title: '适用彩种', sort: false, templet: function (row) {
                            if (!row.CouponUseGames) {
                                return "没限制";
                            }
                            if (row.length >= 16) {
                                return "全部彩种";
                            }
                            var arr = row.CouponUseGames;
                            var lot = '';
                            for (var i = 0; i < arr.length; i++) {
                                lot+= GetGameCodeName(arr[i])+","
                            }
                            lot = lot.substring(0,lot.lastIndexOf(","))
                            return "<span title='"+lot+"'>"+lot+"</span>";
                        }
                    }
                    , {
                        field: 'FillMoney',  title: '金额限制', sort: false, templet: function (row) {
                            if (row.FillMoney == 0) {
                                return "无限制";
                            }
                            else {
                                return "满" + row.FillMoney + "可用";
                            }

                        }}
                    , { field: 'ExpiredTime', title: '过期时间', sort: false }
                    , {
                        field: 'CouponStatus', title: '状态', sort: true, templet: function (row) {
                            if (!row.CouponStatus) {
                                return "未知";
                            }
                            /*if (row.CouponStatus == 0) {
                                return '<span class="layui-badge-dot layui-bg-orange"></span>'+'未激活';
                            }
                            else if (row.CouponStatus == 1) {
                                return "激活";
                            }
                            else if (row.CouponStatus == 2) {
                                return "已使用";
                            }
                            else if (row.CouponStatus == 3) {
                                return "已过期";
                            }
                            else if (row.CouponStatus == 4) {
                                return "禁止";
                            }*/
                            if (row.CouponStatus == 2) {
                                return '<span class="layui-badge-dot layui-bg-green"></span> ' + '已使用';
                            }
                            else if (row.CouponStatus == 3 || row.CouponStatus == 4) {
                                return '<span class="layui-badge-dot"></span> ' + '已过期';
                            }
                            else {
                                return '<span class="layui-badge-dot layui-bg-blue"></span> ' + '未使用';
                            }
                        return "未知";
                    }
                }
                ]]
                , page: true
                , limits: [10, 20, 50]
                , limit: 20
                , done: function (res, cur, count) {
                    if (typeof (count) == "number" && count <= 20) {
                        $(".layui-table-page").css("display", "none");
                    }
                }
            };
            var tableRedBag = table.render(optionsRedBag);

        });
    </script>
}